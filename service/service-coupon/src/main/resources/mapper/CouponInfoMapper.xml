<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="com.atguigu.daijia.coupon.mapper.CouponInfoMapper">

	<resultMap id="couponInfoMap" type="com.atguigu.daijia.model.entity.coupon.CouponInfo" autoMapping="true">
	</resultMap>
	
	<!-- 用于select查询公用抽取的列 -->
	<sql id="columns">
		info.id,info.coupon_type,info.name,info.amount,info.discount,info.condition_amount,info.publish_count,info.per_limit,info.use_count,info.receive_count,info.expire_time,info.describe,info.status,info.create_time,info.update_time,info.is_deleted
	</sql>
	
     <select id="findNoReceivePage" resultType="com.atguigu.daijia.model.vo.coupon.NoReceiveCouponVo">
		 SELECT
		 info.id,
		 info.coupon_type,
		 info.name,
		 info.amount,
		 info.discount,
		 info.condition_amount,
		 info.publish_count,
		 info.per_limit,
		 info.expire_time,
		 info.description
		 FROM coupon_info info
		 LEFT JOIN (SELECT coupon_id,customer_id,COUNT(coupon_id) cnt
		 FROM `customer_coupon`
		 WHERE customer_id = {#customerId}
		 GROUP BY coupon_id) cc
		 ON info.id = cc.coupon_id
		 WHERE info.publish_count &gt; info.receive_count
		 AND (cc.cnt &lt; info.per_limit or info.per_limit = 0 or cc.cnt is null)
		 ORDER BY info.id ASC;
    </select>

	<select id="findNoUsePage" resultType="com.atguigu.daijia.model.vo.coupon.NoUseCouponVo">
		SELECT
		info.id,
		info.coupon_type,
		info.name,
		info.amount,
		info.discount,
		info.condition_amount,
		info.publish_count,
		info.per_limit,
		info.expire_time,
		info.description,

		cstr.receive_time
		FROM coupon_info info
		JOIN customer_coupon cstr
		ON info.id = cstr.coupon_id
		WHERE cstr.expire_time &gt; NOW()
		AND cstr.`status` = 1
		and cstr.customer_id = {#customerId}
		ORDER BY info.id ASC
	</select>

	<select id="findUsedPage" resultType="com.atguigu.daijia.model.vo.coupon.UsedCouponVo">
		select
			info.id,
			info.coupon_type,
			info.name,
			info.amount,
			info.discount,
			info.condition_amount,
			info.publish_count,
			info.per_limit,
			info.expire_time,
			info.describe,

			cstr.id as customerCouponId,
			cstr.used_time
		from coupon_info info
		inner join customer_coupon cstr on cstr.coupon_id = info.id
		where
		cstr.customer_id = #{customerId}
		and cstr.status = 2
		order by cstr.id desc
	</select>

	<update id="updateReceiveCount">
		update coupon_info set receive_count = receive_count + 1 where id = #{id}
	</update>

	<update id="updateReceiveCountByLimit">
		update coupon_info set receive_count = receive_count + 1 where id = #{id} and receive_count &lt; publish_count
	</update>

	<select id="findNoUseList" resultType="com.atguigu.daijia.model.vo.coupon.NoUseCouponVo">
		select
			info.id,
			info.coupon_type,
			info.name,
			info.amount,
			info.discount,
			info.condition_amount,
			info.publish_count,
			info.per_limit,
			info.expire_time,
			info.describe,

			cstr.id as customerCouponId,
			cstr.receive_time
		from coupon_info info
				 inner join customer_coupon cstr on cstr.coupon_id = info.id
		where
			cstr.customer_id = #{customerId}
		  and cstr.status = 1
		  and cstr.expire_time > now()
		order by cstr.id desc
	</select>

	<update id="updateUseCount">
		update coupon_info set use_count = use_count + 1 where id = #{id}
	</update>
</mapper>

